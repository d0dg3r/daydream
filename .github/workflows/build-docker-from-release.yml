name: Build Docker Image from Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (leave empty for latest)'
        required: false
        type: string
  release:
    types: [published]
  schedule:
    # Täglich um 2 Uhr UTC prüfen ob es ein neues Release gibt
    - cron: '0 2 * * *'

jobs:
  build-docker:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest release
        id: get_release
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            # Spezifisches Release verwenden
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            echo "Using specified release tag: ${RELEASE_TAG}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            # Verwendet das gerade veröffentlichte Release
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            echo "Using release event tag: ${RELEASE_TAG}"
          else
            # Neuestes Release finden
            RELEASE_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
            echo "Found latest release tag: ${RELEASE_TAG}"
          fi
          
          # Entferne 'v' Präfix falls vorhanden
          VERSION=${RELEASE_TAG#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION} (tag: ${RELEASE_TAG})"

      - name: Download binary package from release
        id: download_package
        run: |
          RELEASE_TAG="${{ steps.get_release.outputs.tag }}"
          ARCH="x86_64"
          
          # Versuche verschiedene Dateinamen
          PACKAGE_NAME="daydream-binaries-${ARCH}-${{ steps.get_release.outputs.version }}.tar.gz"
          
          # Lade Release-Informationen
          RELEASE_JSON=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${RELEASE_TAG})
          
          # Prüfe ob Release existiert
          if echo "$RELEASE_JSON" | grep -q '"message":"Not Found"'; then
            echo "Error: Release ${RELEASE_TAG} not found"
            exit 1
          fi
          
          # Suche nach dem Binary-Package (nur .tar.gz, keine .md5 oder .sha256)
          # Extrahiere alle URLs und filtere nach daydream-binaries und .tar.gz
          DOWNLOAD_URL=$(echo "$RELEASE_JSON" | grep '"browser_download_url"' | grep 'daydream-binaries' | grep '\.tar\.gz"' | grep -v '\.md5\|\.sha256' | head -1 | sed -E 's/.*"browser_download_url":\s*"([^"]+)".*/\1/')
          
          if [ -z "$DOWNLOAD_URL" ]; then
            # Falls der exakte Name nicht gefunden wurde, suche nach dem ersten Binary-Package
            echo "Exact package name not found, searching for binary package..."
            DOWNLOAD_URL=$(echo "$RELEASE_JSON" | grep '"browser_download_url"' | grep 'daydream-binaries.*\.tar\.gz"' | grep -v '\.md5\|\.sha256' | head -1 | sed -E 's/.*"browser_download_url":\s*"([^"]+)".*/\1/')
          fi
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "Error: Could not find binary package in release ${RELEASE_TAG}"
            echo "Available assets:"
            echo "$RELEASE_JSON" | grep "browser_download_url" | sed 's/.*"browser_download_url":\s*"\([^"]*\)".*/\1/' || true
            exit 1
          fi
          
          # Extrahiere den Dateinamen aus der URL
          FILENAME=$(basename "${DOWNLOAD_URL}" | cut -d '?' -f 1)
          
          echo "Found package: ${FILENAME}"
          echo "Downloading: ${DOWNLOAD_URL}"
          curl -L -f -o "${FILENAME}" "${DOWNLOAD_URL}"
          
          # Verifiziere dass die Datei heruntergeladen wurde
          if [ ! -f "${FILENAME}" ] || [ ! -s "${FILENAME}" ]; then
            echo "Error: Failed to download binary package"
            exit 1
          fi
          
          echo "package_file=${FILENAME}" >> $GITHUB_OUTPUT
          echo "Downloaded package: $(ls -lh ${FILENAME} | awk '{print $5}')"
          
          # Stelle sicher, dass die Datei im Build-Kontext verfügbar ist
          # (sie ist bereits im Workspace, aber Docker braucht sie im Build-Kontext)
          echo "Package is ready for Docker build"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check for Docker Hub credentials
        id: docker_hub_check
        run: |
          if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ]; then
            echo "has_credentials=true" >> $GITHUB_OUTPUT
          else
            echo "has_credentials=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub (optional)
        if: steps.docker_hub_check.outputs.has_credentials == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: |
            daydream-bbs:${{ steps.get_release.outputs.version }}
            daydream-bbs:latest
          build-args: |
            BINARY_PACKAGE=${{ steps.download_package.outputs.package_file }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/daydream-bbs.tar

      - name: Save Docker image as artifact
        run: |
          docker load -i /tmp/daydream-bbs.tar
          docker save daydream-bbs:latest | gzip > daydream-bbs-docker-image.tar.gz
          echo "Docker image saved: $(ls -lh daydream-bbs-docker-image.tar.gz | awk '{print $5}')"

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: daydream-docker-image-${{ steps.get_release.outputs.version }}
          path: daydream-bbs-docker-image.tar.gz
          retention-days: 30

      - name: Push to Docker Hub (if credentials provided)
        if: steps.docker_hub_check.outputs.has_credentials == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/daydream-bbs:${{ steps.get_release.outputs.version }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/daydream-bbs:latest
          build-args: |
            BINARY_PACKAGE=${{ steps.download_package.outputs.package_file }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

