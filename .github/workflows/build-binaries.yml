name: Build DayDream BBS Binaries

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            software-properties-common \
            libpq-dev \
            libtiff-dev libjpeg-dev zlib1g-dev libfreetype6-dev liblcms2-dev \
            libwebp-dev tcl-dev tk-dev \
            curl
          
          # Python 2.7 über deadsnakes PPA installieren (für Ubuntu 22.04+)
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get install -y python2.7 python2.7-dev
          
          # Python 2.7 pip und setuptools installieren
          if ! command -v pip2 &> /dev/null; then
            curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
            python2.7 get-pip.py || true
            rm get-pip.py || true
          fi
          
          # setuptools über pip installieren falls pip verfügbar ist
          if command -v pip2 &> /dev/null; then
            pip2 install setuptools || true
          fi

      - name: Build binaries
        run: |
          cd SRC
          bash make.sh build
          echo "Build completed successfully"

      - name: Create binary package structure
        run: |
          mkdir -p daydream-binaries-$(uname -m)/{bin,lib,utils,doors,python,include}
          
          # Install binaries to temporary directory (muss aus SRC-Verzeichnis aufgerufen werden)
          cd SRC
          INSTALL_PATH=$(pwd)/../daydream-binaries-$(uname -m) bash make.sh install
          cd ..
          
          # Copy shared libraries
          if [ -d SRC/lib ]; then
            find SRC/lib -name "*.so*" -exec cp {} daydream-binaries-$(uname -m)/lib/ \;
          fi
          
          # Copy Python module
          if [ -d SRC/python ]; then
            find SRC/python -name "*.so" -exec cp {} daydream-binaries-$(uname -m)/python/ \;
            find SRC/python -name "*.py" -exec cp {} daydream-binaries-$(uname -m)/python/ \;
          fi

      - name: Create archive
        run: |
          ARCH=$(uname -m)
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # Entferne refs/tags/ - unterstützt sowohl v2.20.0 als auch 2.20.0
            VERSION=${GITHUB_REF#refs/tags/}
            # Entferne optionales 'v' am Anfang
            VERSION=${VERSION#v}
          elif [[ "$GITHUB_REF" == refs/heads/* ]]; then
            BRANCH=${GITHUB_REF#refs/heads/}
            VERSION=${BRANCH}-${GITHUB_SHA::8}
          else
            VERSION=${GITHUB_SHA::8}
          fi
          
          PACKAGE_NAME="daydream-binaries-${ARCH}-${VERSION}"
          echo "Creating archive: ${PACKAGE_NAME}.tar.gz"
          tar -czf ${PACKAGE_NAME}.tar.gz daydream-binaries-${ARCH}/
          
          # Create checksums
          sha256sum ${PACKAGE_NAME}.tar.gz > ${PACKAGE_NAME}.tar.gz.sha256
          md5sum ${PACKAGE_NAME}.tar.gz > ${PACKAGE_NAME}.tar.gz.md5
          
          # List contents for verification
          echo "Archive contents:"
          tar -tzf ${PACKAGE_NAME}.tar.gz | head -20
          
          # Store package name for later steps
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: daydream-binaries-$(uname -m)
          path: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.tar.gz.sha256
            ${{ env.PACKAGE_NAME }}.tar.gz.md5
          retention-days: 90

      - name: Upload to release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.tar.gz.sha256
            ${{ env.PACKAGE_NAME }}.tar.gz.md5
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

