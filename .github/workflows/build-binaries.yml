name: Build DayDream BBS Binaries

on:
  push:
    tags:
      - 'v*'
      - '[0-9]*.[0-9]*.[0-9]*'
    branches:
      - main
      - master
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            software-properties-common \
            libpq-dev \
            libtiff-dev libjpeg-dev zlib1g-dev libfreetype6-dev liblcms2-dev \
            libwebp-dev tcl-dev tk-dev \
            curl
          
          # Python 2.7 über deadsnakes PPA installieren (für Ubuntu 22.04+)
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get install -y python2.7 python2.7-dev
          
          # Python 2.7 pip und setuptools installieren
          if ! command -v pip2 &> /dev/null; then
            curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
            python2.7 get-pip.py || true
            rm get-pip.py || true
          fi
          
          # setuptools über pip installieren falls pip verfügbar ist
          if command -v pip2 &> /dev/null; then
            pip2 install setuptools || true
          fi

      - name: Build binaries
        run: |
          cd SRC
          bash make.sh build
          echo "Build completed successfully"

      - name: Create binary package structure
        run: |
          mkdir -p daydream-binaries-$(uname -m)/{bin,lib,utils,doors,python,include}
          
          # Install binaries to temporary directory (muss aus SRC-Verzeichnis aufgerufen werden)
          cd SRC
          INSTALL_PATH=$(pwd)/../daydream-binaries-$(uname -m) bash make.sh install
          cd ..
          
          # Copy shared libraries
          if [ -d SRC/lib ]; then
            find SRC/lib -name "*.so*" -exec cp {} daydream-binaries-$(uname -m)/lib/ \;
          fi
          
          # Copy Python module
          if [ -d SRC/python ]; then
            find SRC/python -name "*.so" -exec cp {} daydream-binaries-$(uname -m)/python/ \;
            find SRC/python -name "*.py" -exec cp {} daydream-binaries-$(uname -m)/python/ \;
          fi
          
          # Füge Install-Scripts und Dokumentation zum Binary-Package hinzu
          cp README.md daydream-binaries-$(uname -m)/ 2>/dev/null || true
          cp install.sh daydream-binaries-$(uname -m)/ 2>/dev/null || true
          cp install-debian-systemd.sh daydream-binaries-$(uname -m)/ 2>/dev/null || true
          cp upgrade.sh daydream-binaries-$(uname -m)/ 2>/dev/null || true
          
          # Kopiere INSTALL-Verzeichnis (configs, scripts, data, etc.)
          cp -r INSTALL daydream-binaries-$(uname -m)/ 2>/dev/null || true
          
          # Kopiere DOCS-Verzeichnis
          cp -r DOCS daydream-binaries-$(uname -m)/ 2>/dev/null || true
          
          # Kopiere secure.sh falls vorhanden (wird für Permissions benötigt)
          if [ -f "SRC/secure.sh" ]; then
            cp SRC/secure.sh daydream-binaries-$(uname -m)/ 2>/dev/null || true
          fi
          
          # Mache Install-Scripts ausführbar
          chmod +x daydream-binaries-$(uname -m)/install.sh 2>/dev/null || true
          chmod +x daydream-binaries-$(uname -m)/install-debian-systemd.sh 2>/dev/null || true
          chmod +x daydream-binaries-$(uname -m)/upgrade.sh 2>/dev/null || true

      - name: Create archive
        run: |
          ARCH=$(uname -m)
          # Prüfe zuerst ob es ein Tag ist (hat Vorrang)
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # Entferne refs/tags/ - unterstützt sowohl v2.20.0 als auch 2.20.0
            VERSION=${GITHUB_REF#refs/tags/}
            # Entferne optionales 'v' am Anfang
            VERSION=${VERSION#v}
            echo "Using tag version: ${VERSION}"
          elif [[ "$GITHUB_REF" == refs/heads/* ]]; then
            # Prüfe ob es einen Tag auf diesem Commit gibt
            TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
            if [[ -n "$TAG" ]]; then
              VERSION=${TAG#v}
              echo "Found tag on commit: ${VERSION}"
            else
              BRANCH=${GITHUB_REF#refs/heads/}
              VERSION=${BRANCH}-${GITHUB_SHA::8}
              echo "Using branch version: ${VERSION}"
            fi
          else
            VERSION=${GITHUB_SHA::8}
            echo "Using commit version: ${VERSION}"
          fi
          
          PACKAGE_NAME="daydream-binaries-${ARCH}-${VERSION}"
          echo "Creating archive: ${PACKAGE_NAME}.tar.gz"
          tar -czf ${PACKAGE_NAME}.tar.gz daydream-binaries-${ARCH}/
          
          # Create checksums
          sha256sum ${PACKAGE_NAME}.tar.gz > ${PACKAGE_NAME}.tar.gz.sha256
          md5sum ${PACKAGE_NAME}.tar.gz > ${PACKAGE_NAME}.tar.gz.md5
          
          # List contents for verification
          echo "Archive contents:"
          tar -tzf ${PACKAGE_NAME}.tar.gz | head -20
          
          # Store package name for later steps
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Create source package (scripts and docs)
        run: |
          ARCH=$(uname -m)
          # Verwende die gleiche VERSION wie beim Binary-Archiv
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}
          elif [[ "$GITHUB_REF" == refs/heads/* ]]; then
            TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
            if [[ -n "$TAG" ]]; then
              VERSION=${TAG#v}
            else
              BRANCH=${GITHUB_REF#refs/heads/}
              VERSION=${BRANCH}-${GITHUB_SHA::8}
            fi
          else
            VERSION=${GITHUB_SHA::8}
          fi
          
          # Erstelle Source-Package mit Install-Scripts, README, etc.
          SOURCE_PACKAGE_NAME="daydream-source-${VERSION}"
          
          # Temporäres Verzeichnis für Source-Package
          mkdir -p ${SOURCE_PACKAGE_NAME}
          
          # Kopiere wichtige Dateien
          cp README.md ${SOURCE_PACKAGE_NAME}/ 2>/dev/null || true
          cp install.sh ${SOURCE_PACKAGE_NAME}/ 2>/dev/null || true
          cp install-debian-systemd.sh ${SOURCE_PACKAGE_NAME}/ 2>/dev/null || true
          cp upgrade.sh ${SOURCE_PACKAGE_NAME}/ 2>/dev/null || true
          
          # Kopiere INSTALL-Verzeichnis (mit configs, scripts, etc.)
          cp -r INSTALL ${SOURCE_PACKAGE_NAME}/ 2>/dev/null || true
          
          # Erstelle Archiv
          tar -czf ${SOURCE_PACKAGE_NAME}.tar.gz ${SOURCE_PACKAGE_NAME}/
          
          # Checksums
          sha256sum ${SOURCE_PACKAGE_NAME}.tar.gz > ${SOURCE_PACKAGE_NAME}.tar.gz.sha256
          md5sum ${SOURCE_PACKAGE_NAME}.tar.gz > ${SOURCE_PACKAGE_NAME}.tar.gz.md5
          
          # Store für späteren Upload
          echo "SOURCE_PACKAGE_NAME=${SOURCE_PACKAGE_NAME}" >> $GITHUB_ENV
          echo "Created source package: ${SOURCE_PACKAGE_NAME}.tar.gz"

      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: daydream-binaries-$(uname -m)
          path: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.tar.gz.sha256
            ${{ env.PACKAGE_NAME }}.tar.gz.md5
            ${{ env.SOURCE_PACKAGE_NAME }}.tar.gz
            ${{ env.SOURCE_PACKAGE_NAME }}.tar.gz.sha256
            ${{ env.SOURCE_PACKAGE_NAME }}.tar.gz.md5
          retention-days: 90

      - name: Check for tag
        id: check_tag
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            TAG=${TAG#v}
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "has_tag=true" >> $GITHUB_OUTPUT
          else
            TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
            if [[ -n "$TAG" ]]; then
              TAG=${TAG#v}
              echo "tag=${TAG}" >> $GITHUB_OUTPUT
              echo "has_tag=true" >> $GITHUB_OUTPUT
            else
              echo "has_tag=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload to release (if tag exists)
        if: steps.check_tag.outputs.has_tag == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_tag.outputs.tag }}
          files: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.tar.gz.sha256
            ${{ env.PACKAGE_NAME }}.tar.gz.md5
            ${{ env.SOURCE_PACKAGE_NAME }}.tar.gz
            ${{ env.SOURCE_PACKAGE_NAME }}.tar.gz.sha256
            ${{ env.SOURCE_PACKAGE_NAME }}.tar.gz.md5
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary package
        uses: actions/download-artifact@v4
        with:
          name: daydream-binaries-x86_64
          path: .
          pattern: 'daydream-binaries-*.tar.gz'
          merge-multiple: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (optional)
        if: secrets.DOCKER_HUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Extract version from tag
        id: extract_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}
          else
            TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
            if [[ -n "$TAG" ]]; then
              VERSION=${TAG#v}
            else
              VERSION=latest
            fi
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Docker image version: ${VERSION}"

      - name: Find binary package
        id: find_package
        run: |
          PACKAGE=$(ls daydream-binaries-*.tar.gz | head -1)
          if [ -z "$PACKAGE" ]; then
            echo "Error: Binary package not found!"
            exit 1
          fi
          echo "package=${PACKAGE}" >> $GITHUB_OUTPUT
          echo "Using package: ${PACKAGE}"

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: |
            daydream-bbs:${{ steps.extract_version.outputs.version }}
            daydream-bbs:latest
          build-args: |
            BINARY_PACKAGE=${{ steps.find_package.outputs.package }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/daydream-bbs.tar

      - name: Upload Docker image as artifact
        run: |
          docker load -i /tmp/daydream-bbs.tar
          docker save daydream-bbs:latest | gzip > daydream-bbs-docker-image.tar.gz
          
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: daydream-docker-image
          path: daydream-bbs-docker-image.tar.gz
          retention-days: 30

      - name: Push to Docker Hub (if credentials provided)
        if: secrets.DOCKER_HUB_USERNAME != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/daydream-bbs:${{ steps.extract_version.outputs.version }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/daydream-bbs:latest
          build-args: |
            BINARY_PACKAGE=${{ steps.find_package.outputs.package }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

